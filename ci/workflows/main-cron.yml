auto-retry: &auto-retry
  automatic:
    # Agent terminated because the AWS EC2 spot instance killed by AWS.
    - signal_reason: agent_stop
      limit: 3

steps:
  - label: "build"
    command: "ci/scripts/build.sh -p ci-release"
    key: "build"
    if: |
      build.env("CI_STEPS") !~ /(^|,)disable-build(,|$$)/
    plugins:
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 20
    retry: *auto-retry

  - label: "Backfill tests"
    key: "backfill-tests"
    command: "BUILDKITE=${BUILDKITE:-} ci/scripts/backfill-test.sh -p ci-release"
    if: |
      !(build.pull_request.labels includes "ci/main-cron/run-selected") && build.env("CI_STEPS") == null
      || build.pull_request.labels includes "ci/run-backfill-tests"
      || build.env("CI_STEPS") =~ /(^|,)backfill-tests?(,|$$)/
    depends_on:
      - "build"
    plugins:
      - docker-compose#v5.1.0:
          run: source-test-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
      - ./ci/plugins/upload-failure-logs
    timeout_in_minutes: 30
    retry: *auto-retry
    
  # Notification test.
  - key: "test-notify"
    if: build.pull_request.labels includes "ci/main-cron/test-notify" || build.env("CI_STEPS") =~ /(^|,)test_notify(,|$$)/
    command: |
      bash -c 'echo test && exit -1'

  # Notification test.
  - key: "test-notify-2"
    if: build.pull_request.labels includes "ci/main-cron/test-notify" || build.env("CI_STEPS") =~ /(^|,)test_notify(,|$$)/
    command: |
      bash -c 'echo test && exit -1'

  - wait: true
    continue_on_failure: true
    allow_dependency_failure: true

  # Notifies on test failure for certain tests.
  # You may update `notify.py` to add tests and people to notify.
  # This should be the LAST part of the main-cron file.
  - label: "trigger failed test notification"
    if: build.pull_request.labels includes "ci/main-cron/test-notify" || build.branch == "main"
    command: "ci/scripts/notify.py"