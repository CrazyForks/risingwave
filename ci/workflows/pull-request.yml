auto-retry: &auto-retry
  automatic:
    # Agent terminated because the AWS EC2 spot instance killed by AWS.
    - signal_reason: agent_stop
      limit: 3

cargo-cache: &cargo-cache
  id: cargo
  key: "v1-cache-{{ id }}-{{ runner.os }}-{{ checksum 'Cargo.lock' }}"
  restore-keys:
    - "v1-cache-{{ id }}-{{ runner.os }}-"
    - "v1-cache-{{ id }}-"
  backend: s3
  s3:
    bucket: rw-ci-cache-bucket
    args: '--no-progress'
  paths:
    - ".cargo/registry/index"
    - ".cargo/registry/cache"
    - ".cargo/git"

steps:
  - label: "check ci image rebuild"
    plugins:
      - chronotc/monorepo-diff#v2.3.0:
          diff: "git diff --name-only origin/main"
          watch:
            - path: "ci/build-ci-image.sh"
              config:
                command: "ci/build-ci-image.sh"
                label: "ci build images"
  - wait

  - label: "build"
    command: "ci/scripts/build.sh -p ci-dev"
    key: "build"
    plugins:
      - gencer/cache#v2.4.10: *cargo-cache
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 15
    retry: *auto-retry

  - label: "build-release"
    command: "ci/scripts/build.sh -p ci-release"
    key: "build-release"
    plugins:
      - gencer/cache#v2.4.10: *cargo-cache
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 15
    retry: *auto-retry

  - label: "docslt"
    command: "ci/scripts/docslt.sh"
    key: "docslt"
    plugins:
      - gencer/cache#v2.4.10: *cargo-cache
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 10
    retry: *auto-retry

  - label: "end-to-end test (parallel, in-memory) (release)"
    key: "e2e-test-release-parallel-memory"
    command: "ci/scripts/e2e-test-parallel-in-memory.sh -p ci-release"
    if: |
      !(build.pull_request.labels includes "ci/main-cron/run-selected") && build.env("CI_STEPS") == null
      || build.pull_request.labels includes "ci/run-e2e-parallel-in-memory-tests"
      || build.env("CI_STEPS") =~ /(^|,)e2e-parallel-in-memory-tests?(,|$$)/
    depends_on:
      - "build-release"
      - "docslt"
    plugins:
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
      - ./ci/plugins/upload-failure-logs
    timeout_in_minutes: 12
    retry: *auto-retry

  - label: "end-to-end test (parallel, in-memory)"
    if: build.pull_request.labels includes "ci/run-e2e-parallel-in-memory-tests" || build.env("CI_STEPS") =~ /(^|,)e2e-parallel-in-memory-tests?(,|$$)/
    command: "ci/scripts/e2e-test-parallel-in-memory.sh -p ci-dev"
    depends_on: "build"
    plugins:
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
      - ./ci/plugins/upload-failure-logs
    timeout_in_minutes: 12
    retry: *auto-retry

  - label: "micro benchmark"
    command: "ci/scripts/run-micro-benchmarks.sh"
    key: "run-micro-benchmarks"
    if: build.pull_request.labels includes "ci/run-micro-benchmarks" || build.env("CI_STEPS") =~ /(^|,)micro-benchmarks?(,|$$)/
    plugins:
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 60
    retry: *auto-retry

  - label: "upload micro-benchmark"
    if: build.pull_request.labels includes "ci/run-upload-micro-benchmark" || build.env("CI_STEPS") =~ /(^|,)upload-micro-benchmarks?(,|$$)/
    command:
      - "BUILDKITE_BUILD_NUMBER=$BUILDKITE_BUILD_NUMBER ci/scripts/upload-micro-bench-results.sh"
    depends_on: "run-micro-benchmarks"
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            BUILDKITE_TOKEN: buildkite_token
            GITHUB_TOKEN: github-token
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
          environment:
            - BUILDKITE_TOKEN
            - GITHUB_TOKEN
    timeout_in_minutes: 5
